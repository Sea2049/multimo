# MiroFish 系统架构文档

## 1. 架构概述

MiroFish 采用前后端分离的分布式架构，基于多智能体技术实现 AI 预测引擎。系统通过构建高保真的平行数字世界来预测未来事件，核心模块包括图谱构建、环境搭建、多平台模拟、报告生成和深度交互。

### 1.1 设计原则

- **模块化设计**：各功能模块职责清晰，便于独立开发和维护
- **可扩展性**：支持添加新的模拟平台、LLM 服务和报告生成策略
- **高可用性**：采用异步处理和错误恢复机制
- **数据安全**：API 密钥安全存储，用户数据加密传输

### 1.2 技术栈

**后端技术：**
- Python 3.11-3.12
- Flask 3.0+（Web 框架）
- OpenAI SDK（LLM 交互）
- Zep Cloud 3.13.0（长期记忆）
- CAMEL-OASIS 0.2.5（社交模拟引擎）
- PyMuPDF（PDF 解析）

**前端技术：**
- Vue.js 3（前端框架）
- Vue Router（路由管理）
- Axios（HTTP 客户端）
- D3.js（图谱可视化）
- Vite（构建工具）

## 2. 整体架构

### 2.1 系统分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                              │
│                   Vue.js Frontend                           │
│  (Step1-Step5 组件, API 客户端, 路由, 状态管理)                │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP/REST API
┌──────────────────────┴──────────────────────────────────────┐
│                         应用层                                │
│                    Flask Backend                            │
│  (API 蓝图, 业务逻辑服务, 数据模型, 工具函数)                   │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────┴──────────────────────────────────────┐
│                        服务层                                 │
│  - LLM 客户端 (OpenAI SDK)                                   │
│  - Zep Cloud (记忆存储)                                       │
│  - OASIS 框架 (模拟引擎)                                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        MiroFish                              │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 图谱构建模块  │  │ 模拟引擎模块  │  │ 报告生成模块  │      │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤      │
│  │ 实体抽取     │  │ 智能体管理   │  │ 数据分析     │      │
│  │ 关系提取     │  │ 平台模拟     │  │ 报告生成     │      │
│  │ 图谱构建     │  │ 并行执行     │  │ 导出功能     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 环境搭建模块  │  │ 交互模块     │  │ 存储模块     │      │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤      │
│  │ 人设生成     │  │ 智能体对话   │  │ Zep Cloud   │      │
│  │ 配置生成     │  │ 系统对话     │  │ 本地数据库   │      │
│  │ 平台配置     │  │ 动态注入     │  │ 文件存储     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

## 3. 核心模块架构

### 3.1 图谱构建模块

**功能描述：**
- 从种子材料中提取实体和关系
- 构建知识图谱并存储到 Zep Cloud
- 支持图谱可视化和导出

**核心组件：**

| 组件 | 文件路径 | 功能描述 |
|------|---------|---------|
| 实体提取器 | `backend/app/services/graph_builder.py` | 使用 LLM 从文本中提取实体 |
| 关系提取器 | `backend/app/services/graph_builder.py` | 提取实体间的关系 |
| 图谱构建器 | `backend/app/services/graph_builder.py` | 构建知识图谱结构 |
| 图谱存储 | `backend/app/services/zep_graph_memory_updater.py` | 存储图谱到 Zep Cloud |

**数据流：**
```
用户上传种子材料
    ↓
文本处理器 (text_processor.py)
    ↓
实体抽取 + 关系提取 (graph_builder.py)
    ↓
知识图谱构建
    ↓
Zep Cloud 存储
```

### 3.2 模拟引擎模块

**功能描述：**
- 管理多智能体的并行模拟
- 支持 Twitter 和 Reddit 双平台
- 提供模拟状态管理和日志记录

**核心组件：**

| 组件 | 文件路径 | 功能描述 |
|------|---------|---------|
| 智能体实现 | `backend/app/modules/simulation/agent.py` | 基于 LLM 的智能体 |
| 模拟引擎 | `backend/app/modules/simulation/engine.py` | 多智能体模拟引擎 |
| Twitter 平台 | `backend/app/modules/simulation/platforms/twitter.py` | Twitter 平台模拟 |
| Reddit 平台 | `backend/app/modules/simulation/platforms/reddit.py` | Reddit 平台模拟 |
| 模拟管理器 | `backend/app/services/simulation_manager.py` | 管理模拟生命周期 |
| 模拟运行器 | `backend/app/services/simulation_runner.py` | 执行模拟任务 |

**数据流：**
```
模拟配置生成
    ↓
初始化智能体 (LLMBasedAgent)
    ↓
创建平台环境 (Twitter/Reddit)
    ↓
运行模拟循环 (MultiAgentSimulationEngine)
    ↓
记录动作和状态
    ↓
更新时序记忆
```

### 3.3 报告生成模块

**功能描述：**
- 分析模拟数据
- 生成结构化预测报告
- 支持多种导出格式

**核心组件：**

| 组件 | 文件路径 | 功能描述 |
|------|---------|---------|
| 数据分析器 | `backend/app/modules/report/analyzer.py` | 分析模拟数据统计 |
| 报告生成器 | `backend/app/modules/report/generator.py` | 生成结构化报告 |
| 报告智能体 | `backend/app/services/report_agent.py` | 基于 LLM 的报告智能体 |

**数据流：**
```
模拟数据收集
    ↓
数据分析 (DataAnalyzer)
    ↓
报告生成 (ReportGenerator)
    ↓
格式转换 (Markdown/JSON)
    ↓
导出和展示
```

### 3.4 交互模块

**功能描述：**
- 与模拟智能体进行对话
- 与 ReportAgent 进行对话
- 支持动态变量注入

**核心组件：**

| 组件 | 文件路径 | 功能描述 |
|------|---------|---------|
| 聊天接口 | `backend/app/modules/interaction/chat.py` | 聊天交互接口 |
| 模拟 IPC | `backend/app/services/simulation_ipc.py` | 模拟进程间通信 |

## 4. API 架构

### 4.1 API 设计原则

- **RESTful 风格**：遵循 REST 设计规范
- **版本控制**：支持 API 版本管理（/api/v1/）
- **统一响应格式**：标准化的 JSON 响应
- **错误处理**：统一的错误码和错误信息

### 4.2 API 分层

```
API Layer
    ├── /api/v1/graph/*          # 图谱相关 API
    ├── /api/v1/simulation/*     # 模拟相关 API
    └── /api/v1/report/*         # 报告相关 API
```

### 4.3 通用响应格式

**成功响应：**
```json
{
  "success": true,
  "data": {},
  "message": "操作成功"
}
```

**错误响应：**
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述"
  }
}
```

## 5. 数据存储架构

### 5.1 存储层次

```
┌─────────────────────────────────────────────────────────────┐
│                        存储层                                │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Zep Cloud   │  │ 本地数据库   │  │ 文件存储     │      │
│  ├──────────────┤  ├──────────────┤  ├──────────────┤      │
│  │ 实体数据     │  │ SQLite      │  │ 项目文件     │      │
│  │ 关系数据     │  │ 模拟数据     │  │ 模拟日志     │      │
│  │ 长期记忆     │  │ 报告数据     │  │ 报告文件     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 存储说明

| 存储类型 | 用途 | 数据类型 |
|---------|------|---------|
| Zep Cloud | 知识图谱和长期记忆 | 实体、关系、记忆 |
| SQLite | 结构化数据 | 项目、任务、模拟配置 |
| 文件系统 | 文件存储 | 上传文件、报告、日志 |

## 6. 消息流架构

### 6.1 请求响应流程

```
┌─────────────┐    HTTP Request    ┌─────────────┐
│   前端界面   │ ────────────────> │   API 层     │
│   (Vue)     │                    │  (Flask)    │
└─────────────┘                    └─────────────┘
     ↑                                    │
     │                                    │
     │ HTTP Response                      │ Service Call
     │                                    ↓
     │                             ┌─────────────┐
     │                             │  服务层      │
     │                             │  (Services)  │
     │                             └─────────────┘
     │                                    │
     │                                    │
     │                              ┌─────┴─────┐
     │                              │           │
     │                         External     Internal
     │                        Services      Storage
     │                         (LLM,        (Zep, DB)
     │                          Zep)            │
     │                              │           │
     └──────────────────────────────┴───────────┘
```

### 6.2 模拟执行流程

```
用户启动模拟
    ↓
创建模拟任务
    ↓
生成模拟配置
    ↓
初始化模拟引擎
    ↓
创建智能体人设
    ↓
启动模拟进程
    ↓
并行执行 (Twitter + Reddit)
    ↓
收集模拟数据
    ↓
更新模拟状态
    ↓
生成报告
```

## 7. 安全架构

### 7.1 安全措施

1. **API 密钥管理**
   - 使用环境变量存储密钥
   - .env 文件不提交到版本控制
   - 生产环境使用密钥管理服务

2. **CORS 配置**
   - 开发环境：允许所有来源
   - 生产环境：限制具体域名

3. **文件上传安全**
   - 限制文件类型和大小
   - 验证文件内容
   - 隔离上传目录

4. **输入验证**
   - API 参数验证
   - SQL 注入防护
   - XSS 防护

### 7.2 认证授权

当前版本不包含用户认证系统，未来可扩展：
- JWT Token 认证
- 基于角色的访问控制（RBAC）
- API 限流

## 8. 性能优化

### 8.1 优化策略

1. **异步处理**
   - 模拟任务异步执行
   - 报告生成异步处理

2. **缓存机制**
   - API 响应缓存
   - 静态资源缓存

3. **并发控制**
   - 双平台并行模拟
   - 智能体并发执行

4. **资源优化**
   - 连接池管理
   - 内存使用优化

### 8.2 性能指标

| 指标 | 目标值 |
|------|-------|
| API 响应时间 | < 2 秒 |
| 模拟启动时间 | < 5 秒 |
| 报告生成时间 | < 30 秒 |
| 并发模拟数 | 10+ |

## 9. 可扩展性设计

### 9.1 水平扩展

- 后端服务可部署多个实例
- 使用负载均衡分发请求
- 模拟任务可分布式执行

### 9.2 垂直扩展

- 支持更多模拟平台
- 集成新的 LLM 服务
- 添加新的报告生成策略

### 9.3 插件机制

未来可设计插件系统：
- 自定义模拟平台插件
- 自定义报告模板插件
- 自定义数据处理插件

## 10. 部署架构

### 10.1 开发环境

```
┌─────────────────────────────────────────────────────────────┐
│                      本地开发环境                              │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐                         │
│  │  前端服务     │  │  后端服务     │                         │
│  │ :3000 (Vue)  │  │ :5001 (Flask)│                         │
│  └──────────────┘  └──────────────┘                         │
│         ↓                    ↓                                │
│         └────────────────────┘                                │
│                     本地文件系统                                │
│         Zep Cloud + SQLite + File Storage                    │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 生产环境

```
┌─────────────────────────────────────────────────────────────┐
│                      生产环境                                  │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Nginx      │  │  后端集群     │  │  工作队列     │      │
│  │  (反向代理)   │  │  (Flask)     │  │  (Celery)    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│         ↓                    ↓                    ↓          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  前端静态文件  │  │ PostgreSQL  │  │  Redis       │      │
│  │  (CDN)       │  │  (主数据库)   │  │  (缓存)      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                           ↓                                   │
│                    Zep Cloud + File Storage                  │
└─────────────────────────────────────────────────────────────┘
```

## 11. 监控和日志

### 11.1 日志管理

- **日志级别**：DEBUG, INFO, WARNING, ERROR, CRITICAL
- **日志轮转**：按日期和大小轮转
- **日志格式**：时间戳 - 级别 - 模块 - 消息

### 11.2 监控指标

- API 响应时间
- 模拟执行状态
- 系统资源使用
- 错误率统计

### 11.3 告警机制

未来可集成告警系统：
- 模拟失败告警
- API 错误率告警
- 系统资源告警

## 12. 版本历史

### v1.0.0 (2026-01-20)
- 正式发布 v1.0 版本
- 完整实现核心功能模块
- 前后端分离架构
- 集成 Zep Cloud 和 OASIS
- 支持多 LLM 平台

## 13. 参考资料

- [Flask 官方文档](https://flask.palletsprojects.com/)
- [Vue.js 官方文档](https://vuejs.org/)
- [OpenAI API 文档](https://platform.openai.com/docs)
- [Zep Cloud 文档](https://docs.getzep.com/)
- [OASIS 框架文档](https://github.com/camel-ai/oasis)
