# æ–­ç‚¹ç»­ä¼ åŠŸèƒ½åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æ–­ç‚¹ç»­ä¼ åŠŸèƒ½å·²åœ¨é¡¹ç›®ä¸­**å®Œå…¨å®ç°**ï¼Œé€šè¿‡ **è‡ªåŠ¨é©¾é©¶ç®¡ç†å™¨ (Auto-Pilot Manager)** æä¾›ã€‚è¯¥åŠŸèƒ½æ”¯æŒæœåŠ¡é‡å¯åç»§ç»­æ‰§è¡Œæ¨¡æ‹Ÿä»»åŠ¡ï¼Œæ— éœ€ä»å¤´å¼€å§‹ã€‚

---

## âœ… åŠŸèƒ½å¯ç”¨æ€§

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ–­ç‚¹ç»­ä¼  | âœ… å¯ç”¨ | æ”¯æŒæœåŠ¡é‡å¯åä»æ–­ç‚¹ç»§ç»­æ‰§è¡Œ |
| çŠ¶æ€æŒä¹…åŒ– | âœ… å¯ç”¨ | è‡ªåŠ¨ä¿å­˜è¿›åº¦åˆ°æ–‡ä»¶ç³»ç»Ÿ |
| æš‚åœ/æ¢å¤ | âœ… å¯ç”¨ | æ”¯æŒéšæ—¶æš‚åœå’Œæ¢å¤ |
| å¼ºåˆ¶é‡å¯ | âœ… å¯ç”¨ | æ”¯æŒå¼ºåˆ¶é‡æ–°å¼€å§‹ |
| é”™è¯¯æ¢å¤ | âœ… å¯ç”¨ | å¤±è´¥åå¯é‡è¯• |

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

#### 1. **AutoPilotManager** (è‡ªåŠ¨é©¾é©¶ç®¡ç†å™¨)
- **ä½ç½®**: `backend/app/services/auto_pilot_manager.py`
- **èŒè´£**: ç®¡ç†è‡ªåŠ¨é©¾é©¶çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- **å•ä¾‹æ¨¡å¼**: å…¨å±€å”¯ä¸€å®ä¾‹

#### 2. **AutoPilotState** (çŠ¶æ€æ•°æ®ç±»)
- **ä½ç½®**: `backend/app/services/auto_pilot_manager.py` (ç¬¬64-142è¡Œ)
- **èŒè´£**: è®°å½•è‡ªåŠ¨é©¾é©¶çš„å®Œæ•´çŠ¶æ€
- **æŒä¹…åŒ–**: ä¿å­˜åˆ° JSON æ–‡ä»¶

#### 3. **API æ¥å£** (7ä¸ªç«¯ç‚¹)
- **ä½ç½®**: `backend/app/api/simulation.py` (ç¬¬2897-3364è¡Œ)
- **èŒè´£**: æä¾› RESTful æ¥å£

---

## ğŸ”„ å·¥ä½œæµç¨‹

### å®Œæ•´æ‰§è¡Œæµç¨‹

```
å¯åŠ¨è‡ªåŠ¨é©¾é©¶
    â†“
[æ­¥éª¤1] å‡†å¤‡é˜¶æ®µ (PREPARING)
    â”œâ”€ æ£€æŸ¥æ˜¯å¦å·²å‡†å¤‡å®Œæˆ
    â”œâ”€ è¯»å–å®ä½“ã€ç”ŸæˆProfileã€ç”Ÿæˆé…ç½®
    â””â”€ ä¿å­˜çŠ¶æ€æ–‡ä»¶
    â†“
[æ­¥éª¤2] å¯åŠ¨é˜¶æ®µ (STARTING)
    â”œâ”€ æ£€æŸ¥æ˜¯å¦å·²åœ¨è¿è¡Œ
    â”œâ”€ æ£€æµ‹æ˜¯å¦éœ€è¦æ¢å¤ï¼ˆæœ‰è¿›åº¦åˆ™æ¢å¤ï¼‰
    â””â”€ å¯åŠ¨æ¨¡æ‹Ÿè¿è¡Œ
    â†“
[æ­¥éª¤3] ç›‘æ§é˜¶æ®µ (MONITORING)
    â”œâ”€ å®æ—¶ç›‘æ§è¿è¡ŒçŠ¶æ€
    â”œâ”€ æ›´æ–°è¿›åº¦ä¿¡æ¯
    â””â”€ ç­‰å¾…å®Œæˆæˆ–å¤±è´¥
    â†“
[æ­¥éª¤4] æŠ¥å‘Šç”Ÿæˆ (GENERATING_REPORT)
    â”œâ”€ æ£€æŸ¥æ˜¯å¦å·²æœ‰æŠ¥å‘Š
    â””â”€ è‡ªåŠ¨ç”Ÿæˆé¢„æµ‹æŠ¥å‘Š
    â†“
å®Œæˆ (COMPLETED)
```

### æ–­ç‚¹ç»­ä¼ æœºåˆ¶

```
æœåŠ¡é‡å¯
    â†“
åŠ è½½çŠ¶æ€æ–‡ä»¶ (auto_pilot_state.json)
    â†“
æ£€æŸ¥ last_completed_step
    â†“
ä»è¯¥æ­¥éª¤ç»§ç»­æ‰§è¡Œ
    â†“
ç»§ç»­å®Œæˆå‰©ä½™æ­¥éª¤
```

---

## ğŸ“ çŠ¶æ€æŒä¹…åŒ–

### çŠ¶æ€æ–‡ä»¶ä½ç½®
```
backend/data/simulations/auto_pilot/
â””â”€â”€ {simulation_id}_autopilot.json
```

### çŠ¶æ€æ–‡ä»¶ç»“æ„
```json
{
  "simulation_id": "sim_xxxx",
  "mode": "auto",
  "status": "active",
  "current_step": "running",
  "step_progress": 45,
  "step_message": "æ¨¡æ‹Ÿè¿è¡Œä¸­: 50/120 è½®",
  "progress_detail": {
    "current_round": 50,
    "total_rounds": 120,
    "twitter_actions": 500,
    "reddit_actions": 300
  },
  "created_at": "2026-01-21T10:00:00",
  "started_at": "2026-01-21T10:05:00",
  "paused_at": null,
  "completed_at": null,
  "failed_at": null,
  "error": null,
  "error_step": null,
  "last_completed_step": "starting",
  "retry_count": 0
}
```

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### 1ï¸âƒ£ é…ç½®è‡ªåŠ¨é©¾é©¶æ¨¡å¼

**ç«¯ç‚¹**: `POST /api/simulation/auto-pilot/config`

**è¯·æ±‚**:
```json
{
  "simulation_id": "sim_xxxx",
  "mode": "auto"
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "simulation_id": "sim_xxxx",
    "mode": "auto",
    "message": "è‡ªåŠ¨é©¾é©¶æ¨¡å¼å·²å¯ç”¨",
    "available": true
  }
}
```

### 2ï¸âƒ£ å¯åŠ¨è‡ªåŠ¨é©¾é©¶

**ç«¯ç‚¹**: `POST /api/simulation/auto-pilot/start`

**è¯·æ±‚**:
```json
{
  "simulation_id": "sim_xxxx",
  "force": false
}
```

**å‚æ•°è¯´æ˜**:
- `simulation_id`: å¿…å¡«ï¼Œæ¨¡æ‹ŸID
- `force`: å¯é€‰ï¼Œæ˜¯å¦å¼ºåˆ¶é‡æ–°å¼€å§‹ï¼ˆé»˜è®¤falseï¼‰
  - `false`: å¦‚æœå·²æœ‰è¿›åº¦ï¼Œä»æ–­ç‚¹ç»§ç»­
  - `true`: é‡ç½®æ‰€æœ‰çŠ¶æ€ï¼Œä»å¤´å¼€å§‹

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "simulation_id": "sim_xxxx",
    "status": "active",
    "current_step": "preparing",
    "step_progress": 0,
    "step_message": "æ­£åœ¨æ‰§è¡Œ: preparing",
    "message": "è‡ªåŠ¨é©¾é©¶å·²å¯åŠ¨",
    "force_restarted": false
  }
}
```

### 3ï¸âƒ£ è·å–è‡ªåŠ¨é©¾é©¶çŠ¶æ€

**ç«¯ç‚¹**: `POST /api/simulation/auto-pilot/status`

**è¯·æ±‚**:
```json
{
  "simulation_id": "sim_xxxx"
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "simulation_id": "sim_xxxx",
    "mode": "auto",
    "status": "active",
    "current_step": "monitoring",
    "step_progress": 45,
    "step_message": "æ¨¡æ‹Ÿè¿è¡Œä¸­: 50/120 è½®",
    "progress_detail": {
      "current_round": 50,
      "total_rounds": 120,
      "twitter_actions": 500,
      "reddit_actions": 300
    },
    "created_at": "2026-01-21T10:00:00",
    "started_at": "2026-01-21T10:05:00",
    "paused_at": null,
    "completed_at": null,
    "failed_at": null,
    "error": null,
    "last_completed_step": "starting",
    "retry_count": 0,
    "available": true
  }
}
```

### 4ï¸âƒ£ æš‚åœè‡ªåŠ¨é©¾é©¶

**ç«¯ç‚¹**: `POST /api/simulation/auto-pilot/pause`

**è¯·æ±‚**:
```json
{
  "simulation_id": "sim_xxxx"
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "simulation_id": "sim_xxxx",
    "status": "paused",
    "current_step": "monitoring",
    "message": "è‡ªåŠ¨é©¾é©¶å·²æš‚åœ"
  }
}
```

### 5ï¸âƒ£ æ¢å¤è‡ªåŠ¨é©¾é©¶

**ç«¯ç‚¹**: `POST /api/simulation/auto-pilot/resume`

**è¯·æ±‚**:
```json
{
  "simulation_id": "sim_xxxx"
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "simulation_id": "sim_xxxx",
    "status": "active",
    "current_step": "monitoring",
    "message": "è‡ªåŠ¨é©¾é©¶å·²æ¢å¤"
  }
}
```

### 6ï¸âƒ£ åœæ­¢è‡ªåŠ¨é©¾é©¶

**ç«¯ç‚¹**: `POST /api/simulation/auto-pilot/stop`

**è¯·æ±‚**:
```json
{
  "simulation_id": "sim_xxxx"
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "simulation_id": "sim_xxxx",
    "status": "inactive",
    "message": "è‡ªåŠ¨é©¾é©¶å·²åœæ­¢"
  }
}
```

### 7ï¸âƒ£ é‡ç½®è‡ªåŠ¨é©¾é©¶çŠ¶æ€

**ç«¯ç‚¹**: `POST /api/simulation/auto-pilot/reset`

**è¯·æ±‚**:
```json
{
  "simulation_id": "sim_xxxx"
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "simulation_id": "sim_xxxx",
    "message": "è‡ªåŠ¨é©¾é©¶çŠ¶æ€å·²é‡ç½®"
  }
}
```

---

## ğŸ”‘ å…³é”®ç‰¹æ€§

### 1. æ™ºèƒ½æ¢å¤æœºåˆ¶

```python
# æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤
if state.last_completed_step != AutoPilotStep.IDLE and not force:
    logger.info(f"è‡ªåŠ¨é©¾é©¶æ¢å¤æ‰§è¡Œ: from_step={state.current_step.value}")
    state.current_step = state.last_completed_step
else:
    state.current_step = AutoPilotStep.PREPARING
```

**å·¥ä½œåŸç†**:
- è®°å½•æœ€åå®Œæˆçš„æ­¥éª¤ (`last_completed_step`)
- æœåŠ¡é‡å¯åï¼Œä»è¯¥æ­¥éª¤ç»§ç»­æ‰§è¡Œ
- æ”¯æŒå¼ºåˆ¶é‡æ–°å¼€å§‹ (`force=true`)

### 2. çŠ¶æ€ç›‘æ§

```python
# å®æ—¶æ›´æ–°è¿›åº¦
state.step_progress = progress
state.step_message = f"æ¨¡æ‹Ÿè¿è¡Œä¸­: {current_round}/{total_rounds} è½®"
state.progress_detail = {
    "current_round": current_round,
    "total_rounds": total_rounds,
    "twitter_actions": twitter_count,
    "reddit_actions": reddit_count,
}
```

### 3. æš‚åœ/æ¢å¤æœºåˆ¶

```python
# åœ¨æ‰§è¡Œæ­¥éª¤æ—¶æ£€æŸ¥æš‚åœçŠ¶æ€
while state.status == AutoPilotStatus.PAUSED:
    time.sleep(5)
    state = self._load_state(simulation_id)
```

### 4. é”™è¯¯å¤„ç†

```python
# è®°å½•é”™è¯¯ä¿¡æ¯
state.error = error_message
state.error_step = current_step.value
state.status = AutoPilotStatus.FAILED
```

---

## ğŸ“Š çŠ¶æ€è½¬ç§»å›¾

```
INACTIVE
    â†“
    â”œâ”€â†’ ACTIVE (å¯åŠ¨è‡ªåŠ¨é©¾é©¶)
    â”‚       â†“
    â”‚   PAUSED (æš‚åœ)
    â”‚       â†“
    â”‚   ACTIVE (æ¢å¤)
    â”‚       â†“
    â”‚   COMPLETED (å®Œæˆ)
    â”‚
    â””â”€â†’ FAILED (å¤±è´¥)
```

---

## ğŸš€ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ï¼šå¯åŠ¨æ¨¡æ‹Ÿå¹¶æ”¯æŒæ–­ç‚¹ç»­ä¼ 

```bash
# 1. åˆ›å»ºæ¨¡æ‹Ÿ
curl -X POST http://localhost:5001/api/simulation/create \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": "proj_123",
    "graph_id": "graph_456"
  }'

# è¿”å›: simulation_id = "sim_789"

# 2. é…ç½®è‡ªåŠ¨é©¾é©¶æ¨¡å¼
curl -X POST http://localhost:5001/api/simulation/auto-pilot/config \
  -H "Content-Type: application/json" \
  -d '{
    "simulation_id": "sim_789",
    "mode": "auto"
  }'

# 3. å¯åŠ¨è‡ªåŠ¨é©¾é©¶ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
curl -X POST http://localhost:5001/api/simulation/auto-pilot/start \
  -H "Content-Type: application/json" \
  -d '{
    "simulation_id": "sim_789",
    "force": false
  }'

# 4. æŸ¥è¯¢çŠ¶æ€
curl -X POST http://localhost:5001/api/simulation/auto-pilot/status \
  -H "Content-Type: application/json" \
  -d '{
    "simulation_id": "sim_789"
  }'

# 5. å¦‚æœéœ€è¦æš‚åœ
curl -X POST http://localhost:5001/api/simulation/auto-pilot/pause \
  -H "Content-Type: application/json" \
  -d '{
    "simulation_id": "sim_789"
  }'

# 6. æ¢å¤æ‰§è¡Œ
curl -X POST http://localhost:5001/api/simulation/auto-pilot/resume \
  -H "Content-Type: application/json" \
  -d '{
    "simulation_id": "sim_789"
  }'

# 7. æœåŠ¡é‡å¯åï¼Œå†æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨ä»æ–­ç‚¹ç»§ç»­
curl -X POST http://localhost:5001/api/simulation/auto-pilot/start \
  -H "Content-Type: application/json" \
  -d '{
    "simulation_id": "sim_789",
    "force": false
  }'
# ä¼šè‡ªåŠ¨ä» last_completed_step ç»§ç»­æ‰§è¡Œ
```

---

## ğŸ” æ–­ç‚¹ç»­ä¼ å·¥ä½œåŸç†è¯¦è§£

### åœºæ™¯1ï¼šæ­£å¸¸æ‰§è¡Œå®Œæˆ

```
å¯åŠ¨ â†’ å‡†å¤‡ â†’ å¯åŠ¨ â†’ ç›‘æ§ â†’ æŠ¥å‘Š â†’ å®Œæˆ
```

### åœºæ™¯2ï¼šæ‰§è¡Œåˆ°ä¸€åŠæ—¶æœåŠ¡é‡å¯

```
å¯åŠ¨ â†’ å‡†å¤‡ âœ“ â†’ å¯åŠ¨ âœ“ â†’ ç›‘æ§ (50%) â†’ [æœåŠ¡é‡å¯]
                                    â†“
                            åŠ è½½çŠ¶æ€æ–‡ä»¶
                                    â†“
                        last_completed_step = "starting"
                                    â†“
                        ä» "starting" ç»§ç»­ â†’ ç›‘æ§ (50%) â†’ æŠ¥å‘Š â†’ å®Œæˆ
```

### åœºæ™¯3ï¼šæ‰§è¡Œå¤±è´¥åé‡è¯•

```
å¯åŠ¨ â†’ å‡†å¤‡ âœ“ â†’ å¯åŠ¨ âœ“ â†’ ç›‘æ§ âœ— (å¤±è´¥)
                                    â†“
                            çŠ¶æ€: FAILED
                                    â†“
                        è°ƒç”¨ /auto-pilot/reset
                                    â†“
                        é‡æ–°å¯åŠ¨ (force=true)
                                    â†“
                        ä»å¤´å¼€å§‹æ‰§è¡Œ
```

---

## âš™ï¸ é…ç½®å‚æ•°

### AutoPilotState å…³é”®å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `simulation_id` | str | æ¨¡æ‹ŸID |
| `mode` | enum | æ¨¡å¼ï¼šauto / manual |
| `status` | enum | çŠ¶æ€ï¼šinactive / active / paused / completed / failed |
| `current_step` | enum | å½“å‰æ­¥éª¤ |
| `step_progress` | int | æ­¥éª¤è¿›åº¦ (0-100) |
| `step_message` | str | æ­¥éª¤æ¶ˆæ¯ |
| `last_completed_step` | enum | æœ€åå®Œæˆçš„æ­¥éª¤ï¼ˆç”¨äºæ¢å¤ï¼‰ |
| `retry_count` | int | é‡è¯•æ¬¡æ•° |
| `error` | str | é”™è¯¯ä¿¡æ¯ |

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|--------|
| `æ¨¡æ‹Ÿä¸å­˜åœ¨` | simulation_id é”™è¯¯ | æ£€æŸ¥ simulation_id æ˜¯å¦æ­£ç¡® |
| `è¯·å…ˆå¯ç”¨è‡ªåŠ¨é©¾é©¶æ¨¡å¼` | æœªè°ƒç”¨ config æ¥å£ | å…ˆè°ƒç”¨ `/auto-pilot/config` è®¾ç½® mode=auto |
| `è‡ªåŠ¨é©¾é©¶æœªåœ¨è¿è¡Œ` | çŠ¶æ€ä¸æ˜¯ ACTIVE | æ£€æŸ¥å½“å‰çŠ¶æ€ï¼Œå¯èƒ½éœ€è¦æ¢å¤ |
| `è‡ªåŠ¨é©¾é©¶æœªåœ¨æš‚åœçŠ¶æ€` | å°è¯•æ¢å¤ä½†æœªæš‚åœ | å…ˆè°ƒç”¨ pause æ¥å£ |

---

## ğŸ“ˆ ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹çŠ¶æ€æ–‡ä»¶

```bash
# æŸ¥çœ‹è‡ªåŠ¨é©¾é©¶çŠ¶æ€æ–‡ä»¶
cat backend/data/simulations/auto_pilot/sim_xxxx_autopilot.json
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹è‡ªåŠ¨é©¾é©¶ç›¸å…³æ—¥å¿—
grep "auto_pilot" backend/logs/*.log
```

### è°ƒè¯•æ­¥éª¤

1. **æ£€æŸ¥çŠ¶æ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨**
   ```bash
   ls -la backend/data/simulations/auto_pilot/
   ```

2. **æŸ¥çœ‹å½“å‰çŠ¶æ€**
   ```bash
   curl -X POST http://localhost:5001/api/simulation/auto-pilot/status \
     -H "Content-Type: application/json" \
     -d '{"simulation_id": "sim_xxxx"}'
   ```

3. **æ£€æŸ¥é”™è¯¯ä¿¡æ¯**
   ```bash
   # æŸ¥çœ‹ error å’Œ error_step å­—æ®µ
   cat backend/data/simulations/auto_pilot/sim_xxxx_autopilot.json | grep -E "error|error_step"
   ```

---

## âœ¨ æ€»ç»“

### æ–­ç‚¹ç»­ä¼ åŠŸèƒ½å®Œå…¨å¯ç”¨ âœ…

**æ ¸å¿ƒä¼˜åŠ¿**:
1. âœ… **è‡ªåŠ¨æ¢å¤**: æœåŠ¡é‡å¯åè‡ªåŠ¨ä»æ–­ç‚¹ç»§ç»­
2. âœ… **çŠ¶æ€æŒä¹…åŒ–**: å®Œæ•´çš„çŠ¶æ€ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ
3. âœ… **çµæ´»æ§åˆ¶**: æ”¯æŒæš‚åœã€æ¢å¤ã€åœæ­¢ã€é‡ç½®
4. âœ… **å®æ—¶ç›‘æ§**: è¯¦ç»†çš„è¿›åº¦ä¿¡æ¯å’Œé”™è¯¯æ—¥å¿—
5. âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶

**ä½¿ç”¨å»ºè®®**:
- ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨è‡ªåŠ¨é©¾é©¶æ¨¡å¼
- å®šæœŸæ£€æŸ¥çŠ¶æ€æ–‡ä»¶ç¡®ä¿è¿›åº¦ä¿å­˜
- ç›‘æ§æ—¥å¿—åŠæ—¶å‘ç°é—®é¢˜
- æ”¯æŒé•¿æœŸè¿è¡Œï¼ˆæœ€å¤š72å°æ—¶ï¼‰

