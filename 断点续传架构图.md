# 断点续传功能架构图

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端应用 (Vue.js)                         │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  自动驾驶控制面板                                         │   │
│  │  - 启动/暂停/恢复/停止                                    │   │
│  │  - 实时进度显示                                          │   │
│  │  - 状态监控                                              │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP/REST
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    后端 API 层 (Flask)                           │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  /api/simulation/auto-pilot/*                            │   │
│  │  - /config      - 配置模式                               │   │
│  │  - /start       - 启动自动驾驶                           │   │
│  │  - /pause       - 暂停                                   │   │
│  │  - /resume      - 恢复                                   │   │
│  │  - /stop        - 停止                                   │   │
│  │  - /status      - 查询状态                               │   │
│  │  - /reset       - 重置                                   │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              自动驾驶管理器 (AutoPilotManager)                   │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  核心功能                                                │   │
│  │  - 状态管理                                              │   │
│  │  - 步骤编排                                              │   │
│  │  - 错误处理                                              │   │
│  │  - 断点恢复                                              │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  状态数据类 (AutoPilotState)                             │   │
│  │  - simulation_id                                         │   │
│  │  - mode (auto/manual)                                    │   │
│  │  - status (inactive/active/paused/completed/failed)      │   │
│  │  - current_step                                          │   │
│  │  - last_completed_step (用于恢复)                        │   │
│  │  - progress_detail                                       │   │
│  │  - error                                                 │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
    ┌────────┐      ┌────────┐      ┌────────┐
    │ 步骤1  │      │ 步骤2  │      │ 步骤3  │
    │PREPARING│      │STARTING│      │MONITORING│
    └────────┘      └────────┘      └────────┘
        │                │                │
        ▼                ▼                ▼
    ┌────────────────────────────────────────┐
    │  步骤4: GENERATING_REPORT              │
    └────────────────────────────────────────┘
                         │
                         ▼
                    ┌─────────┐
                    │COMPLETED│
                    └─────────┘
```

---

## 🔄 状态转移图

```
                    ┌─────────────┐
                    │  INACTIVE   │
                    └──────┬──────┘
                           │
                    启动自动驾驶
                           │
                           ▼
                    ┌─────────────┐
                    │   ACTIVE    │
                    └──────┬──────┘
                           │
                ┌──────────┼──────────┐
                │          │          │
            暂停│          │          │停止
                │          │          │
                ▼          │          ▼
            ┌────────┐     │     ┌──────────┐
            │ PAUSED │     │     │INACTIVE  │
            └────┬───┘     │     └──────────┘
                 │恢复     │
                 │         │
                 └────┬────┘
                      │
                      ▼
                ┌─────────────┐
                │   ACTIVE    │
                └──────┬──────┘
                       │
            ┌──────────┴──────────┐
            │                     │
        完成│                     │失败
            │                     │
            ▼                     ▼
        ┌─────────┐          ┌────────┐
        │COMPLETED│          │ FAILED │
        └─────────┘          └────────┘
```

---

## 📊 执行流程图

```
启动自动驾驶 (force=false)
    │
    ▼
加载状态文件
    │
    ▼
检查 last_completed_step
    │
    ├─ 是否为 IDLE?
    │
    ├─ 是 ──→ 从 PREPARING 开始
    │
    └─ 否 ──→ 从 last_completed_step 继续
    │
    ▼
执行步骤 1: PREPARING
    │
    ├─ 检查是否已准备完成
    ├─ 读取实体、生成Profile、生成配置
    └─ 保存状态文件
    │
    ▼
执行步骤 2: STARTING
    │
    ├─ 检查是否已在运行
    ├─ 检测是否需要恢复（有进度则恢复）
    └─ 启动模拟运行
    │
    ▼
执行步骤 3: MONITORING
    │
    ├─ 实时监控运行状态
    ├─ 更新进度信息
    └─ 等待完成或失败
    │
    ▼
执行步骤 4: GENERATING_REPORT
    │
    ├─ 检查是否已有报告
    └─ 自动生成预测报告
    │
    ▼
完成 (COMPLETED)
```

---

## 🔄 断点续传工作流

### 正常执行

```
时间轴:
0h      ┌─────────────────────────────────────────┐
        │ 启动自动驾驶                             │
        │ last_completed_step = IDLE              │
        └─────────────────────────────────────────┘
        │
        ▼
1h      ┌─────────────────────────────────────────┐
        │ 完成 PREPARING                          │
        │ last_completed_step = PREPARING         │
        └─────────────────────────────────────────┘
        │
        ▼
2h      ┌─────────────────────────────────────────┐
        │ 完成 STARTING                           │
        │ last_completed_step = STARTING          │
        └─────────────────────────────────────────┘
        │
        ▼
3h      ┌─────────────────────────────────────────┐
        │ 完成 MONITORING                         │
        │ last_completed_step = MONITORING        │
        └─────────────────────────────────────────┘
        │
        ▼
4h      ┌─────────────────────────────────────────┐
        │ 完成 GENERATING_REPORT                  │
        │ last_completed_step = GENERATING_REPORT │
        └─────────────────────────────────────────┘
        │
        ▼
5h      ┌─────────────────────────────────────────┐
        │ 完成 (COMPLETED)                        │
        └─────────────────────────────────────────┘
```

### 中途重启

```
时间轴:
0h      ┌─────────────────────────────────────────┐
        │ 启动自动驾驶                             │
        │ last_completed_step = IDLE              │
        └─────────────────────────────────────────┘
        │
        ▼
1h      ┌─────────────────────────────────────────┐
        │ 完成 PREPARING                          │
        │ last_completed_step = PREPARING         │
        └─────────────────────────────────────────┘
        │
        ▼
2h      ┌─────────────────────────────────────────┐
        │ 完成 STARTING                           │
        │ last_completed_step = STARTING          │
        └─────────────────────────────────────────┘
        │
        ▼
2.5h    ┌─────────────────────────────────────────┐
        │ MONITORING 进行中 (50%)                 │
        │ last_completed_step = STARTING          │
        │                                         │
        │ ⚠️ 服务重启                             │
        └─────────────────────────────────────────┘
        │
        ▼
2.5h    ┌─────────────────────────────────────────┐
        │ 加载状态文件                             │
        │ last_completed_step = STARTING          │
        │                                         │
        │ 从 STARTING 继续 → MONITORING (50%)     │
        └─────────────────────────────────────────┘
        │
        ▼
3h      ┌─────────────────────────────────────────┐
        │ 完成 MONITORING                         │
        │ last_completed_step = MONITORING        │
        └─────────────────────────────────────────┘
        │
        ▼
4h      ┌─────────────────────────────────────────┐
        │ 完成 GENERATING_REPORT                  │
        │ last_completed_step = GENERATING_REPORT │
        └─────────────────────────────────────────┘
        │
        ▼
5h      ┌─────────────────────────────────────────┐
        │ 完成 (COMPLETED)                        │
        └─────────────────────────────────────────┘
```

---

## 📁 文件结构

```
backend/
├── app/
│   ├── services/
│   │   └── auto_pilot_manager.py          # 自动驾驶管理器 (837行)
│   │       ├── AutoPilotMode              # 模式枚举
│   │       ├── AutoPilotStep              # 步骤枚举
│   │       ├── AutoPilotStatus            # 状态枚举
│   │       ├── AutoPilotState             # 状态数据类
│   │       └── AutoPilotManager           # 管理器类
│   │
│   ├── api/
│   │   └── simulation.py                  # API 接口 (第2897-3364行)
│   │       ├── config_auto_pilot()        # 配置接口
│   │       ├── start_auto_pilot()         # 启动接口
│   │       ├── pause_auto_pilot()         # 暂停接口
│   │       ├── resume_auto_pilot()        # 恢复接口
│   │       ├── stop_auto_pilot()          # 停止接口
│   │       ├── get_auto_pilot_status()    # 状态接口
│   │       └── reset_auto_pilot()         # 重置接口
│   │
│   └── config_new.py                      # 配置文件
│
├── data/
│   └── simulations/
│       └── auto_pilot/
│           └── {simulation_id}_autopilot.json  # 状态文件
│
└── tests/
    └── test_auto_pilot.py                 # 测试脚本
```

---

## 🔌 API 调用流程

```
客户端请求
    │
    ▼
┌─────────────────────────────────────────┐
│ API 端点 (Flask 路由)                   │
│ /api/simulation/auto-pilot/*            │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 参数验证                                │
│ - 检查 simulation_id                    │
│ - 检查必填参数                          │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 调用 AutoPilotManager                   │
│ - 获取/创建状态                         │
│ - 执行相应操作                          │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 状态持久化                              │
│ - 保存到 JSON 文件                      │
│ - 更新内存缓存                          │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 返回响应                                │
│ {                                       │
│   "success": true,                      │
│   "data": {...}                         │
│ }                                       │
└─────────────────────────────────────────┘
```

---

## 💾 状态文件结构

```json
{
  "simulation_id": "sim_xxxx",
  "mode": "auto",
  "status": "active",
  "current_step": "monitoring",
  "step_progress": 45,
  "step_message": "模拟运行中: 50/120 轮",
  "progress_detail": {
    "current_round": 50,
    "total_rounds": 120,
    "twitter_actions": 500,
    "reddit_actions": 300
  },
  "created_at": "2026-01-21T10:00:00",
  "started_at": "2026-01-21T10:05:00",
  "paused_at": null,
  "completed_at": null,
  "failed_at": null,
  "error": null,
  "error_step": null,
  "last_completed_step": "starting",
  "retry_count": 0
}
```

---

## 🔄 内存管理

```
┌─────────────────────────────────────────┐
│ AutoPilotManager (单例)                 │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ _states: Dict[str, AutoPilotState]  │ │
│ │ 内存缓存，加快访问速度              │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ _running_tasks: Dict[str, Thread]   │ │
│ │ 后台执行线程                        │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ _monitor_threads: Dict[str, Thread] │ │
│ │ 监控线程                            │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────┐
│ 文件系统                                │
│ backend/data/simulations/auto_pilot/    │
│ {simulation_id}_autopilot.json          │
└─────────────────────────────────────────┘
```

---

## 🔐 线程安全

```
┌─────────────────────────────────────────┐
│ 主线程 (Flask 请求处理)                 │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ API 请求                            │ │
│ │ - 读取状态                          │ │
│ │ - 更新状态                          │ │
│ │ - 保存到文件                        │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────┐
│ 后台线程 (自动驾驶执行)                 │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ _run_auto_pilot()                   │ │
│ │ - 执行步骤                          │ │
│ │ - 更新进度                          │ │
│ │ - 保存状态                          │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘

注意: 通过文件系统实现线程间通信
- 每次更新都保存到文件
- 每次读取都从文件加载最新状态
- 避免内存竞态条件
```

---

## 📊 性能特性

```
┌─────────────────────────────────────────┐
│ 性能指标                                │
├─────────────────────────────────────────┤
│ 最大运行时间      │ 72 小时             │
│ 状态检查间隔      │ 30 秒               │
│ 状态文件大小      │ ~1 KB               │
│ 内存占用          │ 最小化              │
│ 线程数            │ 2-3 个              │
│ 文件 I/O 频率     │ 每步骤完成时 1 次   │
└─────────────────────────────────────────┘
```

---

## 🎯 关键设计决策

### 1. 文件系统持久化
- **优点**: 简单可靠，支持服务重启
- **缺点**: I/O 性能相对较低
- **选择理由**: 可靠性优先

### 2. 单例模式
- **优点**: 全局唯一实例，状态一致
- **缺点**: 不支持多进程
- **选择理由**: 单进程 Flask 应用

### 3. 后台线程执行
- **优点**: 不阻塞 API 响应
- **缺点**: 需要线程安全处理
- **选择理由**: 用户体验优先

### 4. 步骤式执行
- **优点**: 支持断点续传，易于监控
- **缺点**: 步骤间有延迟
- **选择理由**: 可靠性和可维护性优先

---

## 📈 扩展性

```
当前架构支持:
├─ 单个模拟的完整生命周期管理
├─ 多个模拟的并行执行
├─ 服务重启后的自动恢复
└─ 实时状态监控

未来可扩展:
├─ 分布式执行（多进程/多机器）
├─ 数据库持久化（替代文件系统）
├─ WebSocket 实时推送
└─ 高级监控和告警
```

---

**架构图版本**: 1.0
**最后更新**: 2026-01-21

