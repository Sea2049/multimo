# 断点续接功能检查与优化方案

## 📋 现状分析

### ✅ 已实现的功能

1. **后端恢复机制**（`simulation_runner.py`）
   - `start_simulation()` 支持 `resume=True` 参数
   - 检测 `run_state.json` 中的 `current_round` 判断是否有进度
   - 恢复模式下使用追加模式打开日志文件
   - 传递 `--resume` 参数给模拟脚本

2. **脚本层恢复逻辑**（`run_parallel_simulation.py`）
   - 检测现有数据库文件判断是否需要恢复
   - 调用 `get_last_completed_round()` 获取最后完成的轮次
   - 从 `start_round + 1` 继续执行
   - 恢复模式下读取数据库 `rowid` 避免重复记录

3. **自动驾驶恢复**（`auto_pilot_manager.py`）
   - 检查 `last_completed_step` 判断是否需要恢复
   - 自动检测已有进度并传递 `resume=True`
   - 支持暂停/恢复自动驾驶流程

## ❌ 发现的问题

### 🔴 严重问题

1. **前端缺少恢复入口**
   - `Step3Simulation.vue` 中 `handleStartSimulation()` 强制使用 `force: true`
   - 这会清理所有旧日志，导致无法恢复
   - 用户停止模拟后，提示"停止后将无法恢复或继续运行"（第454行）
   - **实际上后端支持恢复，但前端没有提供恢复选项**

2. **API 接口未暴露 resume 参数**
   - `/api/simulation/start` 接口没有接收 `resume` 参数
   - 前端无法通过 API 触发恢复模式
   - 只有自动驾驶模式内部使用了恢复功能

3. **状态判断逻辑冲突**
   - 停止后状态变为 `PAUSED`，但前端提示"无法恢复"
   - `force` 模式会清理日志，与恢复功能互斥
   - 缺少明确的"可恢复"状态标识

### 🟡 次要问题

4. **缺少恢复前的状态验证**
   - 没有检查数据库文件完整性
   - 没有验证日志文件是否损坏
   - 缺少恢复失败的回退机制

5. **用户体验不友好**
   - 没有显示可恢复的进度信息（已完成多少轮）
   - 缺少恢复成功/失败的明确反馈
   - 没有恢复历史记录

6. **文档缺失**
   - README 提到"断点续传"但没有使用说明
   - 缺少恢复功能的 API 文档

## 🎯 优化方案

### 第一阶段：核心功能修复（高优先级）

1. **修改 API 接口**
   - `simulation.py` 的 `/start` 接口添加 `resume` 参数
   - 当 `resume=true` 时，不执行日志清理
   - 传递 `resume` 参数给 `SimulationRunner.start_simulation()`

2. **修改前端启动逻辑**
   - `Step3Simulation.vue` 添加恢复模式检测
   - 检测到已有进度时，显示恢复选项
   - 提供"重新开始"和"继续运行"两个按钮
   - 移除误导性的"无法恢复"提示

3. **添加状态查询接口**
   - 新增 `/api/simulation/{id}/resumable` 接口
   - 返回是否可恢复、已完成轮次、总轮次等信息

### 第二阶段：用户体验优化（中优先级）

4. **增强前端 UI**
   - 显示恢复进度信息："已完成 X/Y 轮，是否继续？"
   - 添加恢复确认对话框
   - 恢复过程中显示特殊标识

5. **添加状态验证**
   - 恢复前检查数据库文件是否存在
   - 验证日志文件完整性
   - 检测到异常时提示用户选择强制重新开始

6. **改进错误处理**
   - 恢复失败时自动回退到重新开始
   - 记录恢复失败原因到日志
   - 提供详细的错误提示

### 第三阶段：高级功能（低优先级）

7. **恢复历史记录**
   - 记录每次恢复的时间和轮次
   - 支持查看恢复历史
   - 统计恢复成功率

8. **完善文档**
   - 更新 README 添加断点续接使用说明
   - 添加 API 文档说明 resume 参数
   - 提供恢复功能的最佳实践

## 📝 具体修改清单

### 后端修改（3个文件）

1. **`backend/app/api/simulation.py`**
   - 第1599行：添加 `resume` 参数接收
   - 第1604行：传递 `resume` 参数
   - 新增：`/resumable` 查询接口

2. **`backend/app/services/simulation_runner.py`**
   - 第356-360行：增强恢复逻辑验证
   - 添加数据库完整性检查

3. **新增：`backend/app/api/simulation.py`**
   - 添加 `/api/simulation/{id}/resumable` 接口

### 前端修改（2个文件）

1. **`frontend/src/components/Step3Simulation.vue`**
   - 第408-420行：移除 `force: true`，改为条件判断
   - 第454行：修改提示文字
   - 新增：恢复模式检测和 UI
   - 新增：查询可恢复状态的方法

2. **`frontend/src/api/simulation.js`**
   - 新增：`checkResumable()` API 方法

## ⚠️ 风险评估

- **低风险**：API 参数添加（向后兼容）
- **中风险**：前端 UI 改动（需要测试用户流程）
- **低风险**：状态验证逻辑（纯新增功能）

## 🧪 测试计划

1. 启动模拟 → 运行几轮 → 停止 → 验证可恢复状态
2. 点击"继续运行" → 验证从正确轮次恢复
3. 点击"重新开始" → 验证日志被清理
4. 恢复过程中断 → 验证可以再次恢复
5. 删除数据库文件 → 验证恢复失败提示

## 📊 预期效果

- ✅ 用户可以随时停止和恢复模拟
- ✅ 清晰的 UI 提示和操作选项
- ✅ 完善的错误处理和回退机制
- ✅ 提升用户体验和系统可靠性