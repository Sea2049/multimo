# 迁移报告下载与增补文档功能计划

## 1. 目标
将 `ReportView.vue` (Step 4) 中已实现的 "报告下载" 和 "增补文档" 功能，迁移到 `Step5Interaction.vue` (Step 5) 中。

## 2. 现有实现分析 (ReportView.vue)
- **报告下载**:
    - 按钮: `Export Report`
    - 方法: `handleExportReport`
    - 逻辑: 调用后端 API `/api/v1/report/{simulationId}/download?format=markdown`
- **增补文档**:
    - 按钮: `补充文档`
    - 弹窗: `showAddDocModal` 控制的模态框
    - 逻辑:
        - 文件选择/拖拽 (`handleFileSelect`, `handleDrop`)
        - 上传 API: `addDocuments`
        - 状态轮询: `pollTaskStatus`
        - 依赖数据: `projectData` (需要 `project_id`)

## 3. 迁移方案

### 3.1 修改文件
- `frontend/src/components/Step5Interaction.vue`

### 3.2 实施步骤

1.  **引入必要的 API 和组件**:
    - 引入 `addDocuments`, `getTaskStatus`, `getProject`, `getSimulation` 等 API。
    - 引入 `ref`, `computed` 等 Vue 组合式 API。

2.  **复制状态变量**:
    - 复制 `showAddDocModal`, `uploadFiles`, `isDragOver`, `uploading`, `uploadStatus`, `fileInput` 等状态。
    - 复制 `projectData` 状态（用于获取 `project_id`）。

3.  **复制业务逻辑方法**:
    - 复制 `handleExportReport` (需适配 Step 5 的上下文)。
    - 复制 `handleAddDocuments`, `closeAddDocModal`, `triggerFileInput`, `handleFileSelect`, `handleDragOver`, `handleDragLeave`, `handleDrop`, `addFiles`, `removeFile`, `formatFileSize`, `submitDocuments`, `pollTaskStatus`。
    - 添加 `loadProjectData` 方法，确保在 Step 5 初始化时获取到 `project_id`。

4.  **更新 UI 模板**:
    - 在 `Step5Interaction.vue` 的 `action-bar` (操作栏) 中添加 "下载报告" 和 "补充文档" 按钮。
    - 将 `ReportView.vue` 中的模态框代码 (`<div v-if="showAddDocModal" ...>`) 复制到 `Step5Interaction.vue` 的模板底部。
    - 适配样式，确保模态框和按钮在 Step 5 的布局中显示正常。

### 3.3 样式适配
- 复制 `ReportView.vue` 中关于模态框 (`.modal-overlay`, `.modal-content` 等) 和上传区域 (`.upload-zone` 等) 的 CSS 样式到 `Step5Interaction.vue`。

## 4. 代码变更预览

### Step5Interaction.vue (Template)

```html
<!-- 在 action-bar-tabs 中添加按钮 -->
<div class="action-bar-tabs">
  <!-- 现有 tabs ... -->
  
  <div class="tab-divider"></div>
  
  <!-- 新增按钮 -->
  <button class="tab-pill" @click="handleAddDocuments" title="补充文档到知识库">
    <svg>...</svg> 补充文档
  </button>
  <button class="tab-pill" @click="handleExportReport" title="导出报告">
    <svg>...</svg> 导出报告
  </button>
</div>

<!-- 底部添加模态框 -->
<div v-if="showAddDocModal" class="modal-overlay" ...>
  <!-- ... 模态框内容 ... -->
</div>
```

### Step5Interaction.vue (Script)

```javascript
// 引入 API
import { addDocuments, getTaskStatus, getProject } from '../api/graph'
import { getSimulation } from '../api/simulation'

// 状态定义
const showAddDocModal = ref(false)
const projectData = ref(null)
// ... 其他上传相关状态

// 方法定义
const handleExportReport = () => { ... }
const submitDocuments = async () => { ... }
// ... 其他上传相关方法

// 初始化加载项目数据
const loadProjectData = async () => {
  // 通过 simulationId 获取 project_id
}

onMounted(() => {
  // ... 现有初始化
  loadProjectData()
})
```

## 5. 待确认事项
- Step 5 的 `simulationId` prop 是否总是可用？(是的，`Step5Interaction` 接收 `simulationId` prop)
- 样式是否需要微调以匹配 Step 5 的整体风格？(将尽量保持一致，使用 Step 5 的 `tab-pill` 样式)

## 6. 下一步
确认计划后，我将开始修改 `Step5Interaction.vue`。